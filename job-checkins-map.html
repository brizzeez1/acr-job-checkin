<!DOCTYPE html>
<html>
<head>
  <title>Live Job Check‑Ins Map</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha384-sA+4UU+8aybXBZrIEhp7H42WbbGBGxq+HX+Oqc7W2eQ2KeoeduDP+W5X3OoLIb8J"
    crossorigin=""
  />

  <style>
    body { margin: 0; }
    #map { height: 100vh; width: 100%; }
  </style>
</head>
<body>

  <div id="map"></div>

  <!-- Leaflet JS -->
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha384-Kzo3g8jKY6s52IbzvXD4qLzc23kzYzQht+z2xW4ce6ee+jqfdJGPkll0K9ON2zlk"
    crossorigin=""
  ></script>

  <!-- PapaParse for CSV -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

  <script>
    // 1) Your published‐to‐web CSV URL:
    const sheetUrl = 
      "https://docs.google.com/spreadsheets/d/e/2PACX-1vRJlw6hMgViLlMPytg-Pwwn73EDzcFOjxndcjN8vBkNnOLGCo-SErsbTVwmhgHGEJSfa8lElgSkQILz/pub?output=csv";

    // 2) Simple slugify for city pages (e.g. "Phoenix" → "phoenix-az")
    function slugify(str) {
      return str
        .toLowerCase()
        .trim()
        .replace(/[^a-z0-9]+/g, "-")
        .replace(/^-+|-+$/g, "");
    }

    // 3) Init the map centered on Phoenix
    const map = L.map("map").setView([33.4484, -112.0740], 9);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      attribution: "&copy; OpenStreetMap contributors"
    }).addTo(map);

    // 4) Define a reliable **red** icon (not blocked by ad‑blockers)
    const redIcon = L.icon({
      iconUrl:    "https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png",
      shadowUrl:  "https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png",
      iconSize:     [25, 41],
      iconAnchor:   [12, 41],
      popupAnchor:  [1, -34],
      shadowSize:   [41, 41]
    });

    // 5) Fetch & parse the sheet, then place markers
    Papa.parse(sheetUrl, {
      download: true,
      header: true,
      complete: function(results) {
        results.data.forEach(row => {
          // only if we have a city + valid coords
          const lat = parseFloat(row.Latitude);
          const lng = parseFloat(row.Longitude);
          if (!row.City || isNaN(lat) || isNaN(lng)) return;

          // build city slug and popup HTML
          const citySlug = slugify(row.City + "-az");
          const popupHtml = `
            <div style="line-height:1.3; max-width:220px">
              <strong>Work:</strong> ${row["Type of Work"] || "—"}<br>
              <strong>Tech:</strong> ${row["Tech Name"] || "—"}<br>
              <div style="margin:8px 0; font-size:0.9em;">${row["Summary"] || ""}</div>
              <a href="/service-area/${citySlug}">
                See all jobs in ${row.City}
              </a>
            </div>`;

          // add the marker with our redIcon
          L.marker([lat, lng], { icon: redIcon })
            .addTo(map)
            .bindPopup(popupHtml);
        });
      }
    });
  </script>
</body>
</html>
